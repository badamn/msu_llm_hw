# Система анализа новостей Telegram для прогноза MOEX

Система для бинарной классификации направления изменения цены акций на Московской бирже (MOEX) на основе новостей из Telegram каналов с использованием больших языковых моделей (LLM).

## Постановка задачи

Система собирает новости из выбранных Telegram каналов, обрабатывает их с помощью LLM для извлечения признаков и выдает прогноз направления изменения цены (вверх/вниз) на заданном горизонте. После этого проводится оценка точности по фактическим котировкам MOEX.

### Параметры целевой задачи

- **Тикеры MOEX**: GAZP, SBER, LKOH
- **Окно новостей (W)**: 24 часа до момента прогноза
- **Горизонт прогноза (H)**: До закрытия следующего торгового дня
- **Таймзона**: MSK (Europe/Moscow)

### Описание окна W и горизонта H

- **Окно новостей (W = 24 часа)**: Все сообщения из Telegram каналов за последние 24 часа до момента формирования прогноза используются для анализа и извлечения признаков.

- **Горизонт прогноза (H)**: Прогноз делается на период до закрытия следующего торгового дня после момента прогноза. Целевая метка формируется как направление изменения цены закрытия между текущим моментом и моментом закрытия следующего торгового дня.

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository_url>
cd msu_llm
```
**Опционально:** 1.5: Добавьте проект из `pyproject.toml` к пакетному менеджеру

2. Установите зависимости:
```bash
pip install -r requirements.txt
```
**Опционально:** 2.5: Если вы работаете через пакетный менеджер и синхронизировали проект, запустите виртуальную среду:
```bash
source .venv/bin/activate
```

3. Настройте конфигурацию:
   - Отредактируйте `configs/config.yaml`
   - Укажите параметры задачи, пути к данным, API ключи

## Структура проекта

```
msu_llm/
├── README.md                    # Этот файл
├── requirements.txt             # Зависимости
├── run_experiment.py            # Единая точка запуска всего пайплайна end-to-end
├── configs/
│   └── config.yaml              # Параметры окна, горизонта, тикеров, путей к данным и ключей
├── data/                        # Образцы данных или скрипты загрузки
│   ├── README.md                # Инструкции по воспроизводимости данных
│   ├── telegram/                # Данные из Telegram
│   └── moex/                    # Данные MOEX
├── src/                         # Модули системы
│   ├── __init__.py
│   ├── ingest_telegram.py       # Сбор новостей из Telegram
│   ├── load_moex.py             # Загрузка котировок MOEX
│   ├── llm_features.py          # Извлечение признаков через LLM
│   ├── baseline.py              # Базовые методы/утилиты (обработка текста)
│   ├── classifier.py            # Классификатор (zero-shot или легкая модель)
│   ├── evaluate.py              # Оценка качества модели
│   └── models.py                # Модели данных
└── notebooks/                   # Опционально: исследование данных/абляции
    └── experiments.ipynb        # Ноутбук для экспериментов и анализа
```

## Запуск

### Полный эксперимент end-to-end

```bash
python run_experiment.py --config configs/config.yaml
```

### С дополнительными параметрами

```bash
python run_experiment.py \
    --config configs/config.yaml \
    --ticker GAZP \
    --window 24 \
    --horizon 24
```

### Параметры командной строки

- `--config`: Путь к конфигурационному файлу (по умолчанию: `configs/config.yaml`)
- `--ticker`: Один тикер для анализа (переопределяет config)
- `--window`: Окно новостей в часах (переопределяет config)
- `--horizon`: Горизонт прогноза в часах (переопределяет config)

## Описание данных

### Источники данных

1. **Telegram каналы**: 
   - Сбор через Telethon API и TGstat API
   - Поддержка фильтрации по категориям каналов
   - Формат: JSON с метаданными постов (текст, дата, просмотры, реакции)

2. **MOEX котировки**:
   - Источник: MOEX ISS API (https://iss.moex.com/iss)
   - Формат: OHLCV данные (Open, High, Low, Close, Volume)
   - Период: настраивается в конфигурации

### Период и таймзона

- **Период**: Настраивается в `configs/config.yaml` (по умолчанию: 2024-01-01 - 2024-12-31)
- **Таймзона**: MSK (Europe/Moscow)
- **Торговые сессии**: Пн-Пт, 9:00-18:45 MSK

### Список каналов или критерии отбора

Каналы можно указать вручную в `configs/config.yaml` в секции `channels`, либо система может автоматически искать каналы по категориям через TGstat API.

Пример конфигурации каналов:
```yaml
channels:
  - uri: "@finance_channel"
    category: "Финансы"
  - uri: "@stock_market_news"
    category: "Рынки"
```

## Конфигурация

Основные параметры настраиваются в `configs/config.yaml`:

- **task**: Параметры задачи (тикеры, окно W, горизонт H, даты)
- **telegram**: Параметры Telegram API
- **llm**: Параметры LLM (vsegpt.ru API)
- **classifier**: Метод классификации
- **data**: Пути к данным
- **output**: Пути для результатов

## Результаты

После выполнения эксперимента результаты сохраняются в:

### `data/results/evaluation_results.json`
- **Balanced Accuracy** — основная метрика оценки (с 95% доверительным интервалом)
- **Accuracy, Precision, Recall, F1-Score** — дополнительные метрики
- **Confusion Matrix** — матрица ошибок
- **Classification Report** — детальный отчет о классификации

### `data/results/predictions_log.json`
Детальный лог всех предсказаний для воспроизводимости:
- Timestamp каждого прогноза
- Окно новостей (window_start, window_end)
- Предсказанное направление и уверенность
- Фактическое направление
- Корректность прогноза

Результаты также выводятся в консоль во время выполнения.

## Ноутбук для экспериментов

Для исследования данных и проведения абляционных экспериментов используйте ноутбук `notebooks/experiments.ipynb`:

```bash
jupyter notebook notebooks/experiments.ipynb
```

Ноутбук содержит:
- Исследование данных Telegram
- Анализ котировок MOEX
- Абляционные эксперименты с параметрами W и H
- Сравнение методов классификации
- Визуализацию результатов оценки
- Анализ ошибок модели

## Методы классификации

Система поддерживает несколько методов:

### LLM-методы (без обучения)
1. **Zero-shot** (`method: "zero-shot"`): Прямая классификация через LLM без примеров
   - Агрегация предсказаний по всем постам в окне W (взвешенное голосование по confidence)
   - Улучшенные промпты с контекстом компании и сектора

2. **Few-shot** (`method: "few-shot"`): Классификация с примерами

### ML-методы (с обучением)
3. **Logistic Regression** (`method: "logistic"`): Логистическая регрессия поверх признаков
4. **Gradient Boosting** (`method: "gradient_boosting"`): Градиентный бустинг поверх признаков

Для ML-методов автоматически выполняется:
- **Train/test split по времени** (80% train / 20% test) для предотвращения утечки данных
- Извлечение признаков через LLM (sentiment, urgency, event_type, direction_prediction)
- Обучение модели на train данных
- Оценка на test данных

Метод выбирается в конфигурации (`classifier.method`).

## Воспроизводимость

- Кэширование ответов LLM для воспроизводимости результатов
- Сохранение всех промежуточных данных
- Детальное логирование процесса
- Использование фиксированных random seeds для моделей

## Требования

- Python 3.8+
- Все зависимости из `requirements.txt`
- API ключи для Telegram и vsegpt.ru
- Доступ к интернету для загрузки данных

## Лицензия

[Укажите лицензию]

## Автор

[Укажите автора]

# msu_llm_hw
